# TCP/IP 4계층 전송 계층(transport) TCP와 UDP

## Transport Layer(전송 계층)

TCP/IP 4계층의 transport 계층은 OSI 7계층의 transport 계층과 같으며, 목적지까지 **신뢰성** 있는 데이터의 **전송**을 담당하는 계층

전송 계층에는 2가지 역할이 있다.

첫 번째는, **오류를 점검하는 역할**으로 오류 발생시 재전송을 요청하여 데이터를 정확히 전달한다. (데이터의 순차적, 안정적 전달 → 신뢰성)

두 번째는, 전송된 **데이터의 목적지가 어떤 어플리케이션인지 식별하는 역할**이다. (포트 번호에 해당하는 프로세스에 데이터를 전달 → 전송)

### 전송 계층이 없다면?

- 데이터의 순차 전송이 원활하지 않다.
- 흐름 문제(Flow) : 송수신자 간 데이터 처리 속도 차이가 존재할 수 있으며, 수신자가 데이터 한계량을 초과했는데 송신자 측에서 데이터를 전송하려고 할 경우 데이터가 누락되는 문제가 발생한다.
- 혼잡 문제(Congestion) : 네트워크 데이터 처리 속도에 의해서 데이터가 제대로 전송되지 않을 수 있다.

→ **데이터의 손실이 발생**

전송 계층의 통신 방법은 크게 2가지가 있다.

## 연결형 통신

**신뢰할 수 있고 정확한 데이터를 목적지에 문제 없이 전달하는 통신**

**신뢰성/정확성**을 위해 여러 번 확인하고 데이터를 보낸다.

이러한 통신을 위해 사용되는 프로토콜이 **TCP**이다.

전송이 양방향으로 동시에 일어나는 **full-duplex(전이중 통신 방식)**

각 연결이 정확히 2개의 종단점을 가지는 **point-to-point(점대점 방식)**

## 비연결형 통신

**데이터를 빠르고 효율적으로 전달하는 통신**

**효율성**을 위해 확인 절차 없이 일방적으로 데이터를 보낸다.

이러한 통신을 위해 사용되는 프로토콜이 **UDP**이다.

![연결형통신과비연결형통신](https://github.com/hajaeryul/mvc-20220927-jaeryul/assets/113097210/3d14be30-9ed3-49c9-9fc7-8d542ee83ce6)

---

# TCP(Transmission Control Protocol)

전송 계층에서 신뢰할 수 있는 정확한 통신을 제공하는, **신뢰성/정확성**이 우선인 **연결형 통신 프로토콜**

상위 레이어에서 받은 데이터를 TCP내부에서 자르고 붙이는 헤더를 TCP 헤더라고 한다.

TCP 헤더가 붙은 데이터를 **Segment(세그먼트)** 라고 한다.

![TCP헤더](https://github.com/hajaeryul/mvc-20220927-jaeryul/assets/113097210/67b3e4e5-a398-46b3-b0bb-e8f7a722e539)

데이터를 전송하기 전에 **연결(connection)** 이라는 **가상의 독점 통신로** 확보 작업을 해야 하는데, 이 연결을 확립한 후 데이터를 전송할 수 있다.

6비트의 코드 비트에는 이 연결의 제어 정보가 기록된다.

SYN(연결 요청), ACK(응답 제어), FIN(연결 종료)

### TCP헤더 추가 설명

- Falg 필드에는 URG, ACK, PSH, RST, SYN, FIN가 존재한다(위 설명에서 제어 정보가 기록되는 6비트)
    
    Reserved(예약)필드는 현재 사용하지 않지만, 나중을 위해 예약된 필드로서 그림엔 6bit가 할당되어 있지만 혼잡 제어 기능 향상을 위해 현재는 Flag 코드의 NS, CWR, ECE 플래그가 각 1비트씩 Reserved필드를 사용하고 있다
    
- Option은 TCP의 기능을 확장할 때 사용하는 필드이며, 이 필드는 크기가 가변적이다.
    
    옵션을 모두 사용했을 때 최대 길이는 40Byte이다. (그림에서는 오른쪽 세로 화살표까지가 기본적인 TCP헤더의 크기이다)
    
    대표적인 옵션으로는 Window size 확장을 위한 WSCALE, Selective Reapeat 방식을 사용하기 위한 SACK 등이 있으며, 약 30개 정도의 사용할  수 있는 옵션이 있다.

## 3-way handshake

**SYN, ACK** 컨트롤 비트로 연결을 확인한다.

![크3way핸드셰크](https://github.com/hajaeryul/mvc-20220927-jaeryul/assets/113097210/989e8e79-efa7-4818-bcb2-9b70d3330eaa)

1. 클라이언트 측에서 SYN 비트를 1로 설정하여 전송
  
2. 서버 측에서 응답을 알리기 위해 SYN, ACK 비트를 1로 설정하여 전송
  
3. 클라이언트 측에서 허가한다는 응답으로 ACK 비트를 1로 설정하여 전송
  

## 4-way handshake

데이터를 전송할 때 뿐만 아니라 전송한 후에도 **연결을 끊기 위한 요청**을 교환해야 한다. 연결을 끊을 때는 **FIN, ACK** 컨트롤 비트를 사용한다.

![4way핸드셰이크](https://github.com/hajaeryul/mvc-20220927-jaeryul/assets/113097210/77bf36bf-96b4-4792-826f-1c43cd0ca1c2)

## 일련 번호(sequence number)와 확인 응답 번호(acknowledgement number)

- **일련 번호**는 송신 측에서 수신 측에 이 데이터가 **몇 번째 데이터인지 알려주는 역할**을 한다.
  
  이 번호를 통해 수신 측은 원래 데이터의 몇 번째 데이터를 받았는지 알 수 있다.
  
- **확인 응답 번호**는 수신 측이 **몇 번째 데이터를 수신했는지 송신 측에 알려주는 역할**을 한다.
  
  받은 데이터의 다음 번호의 데이터를 요청하는 데 사용한다.
  

하지만 데이터가 항상 올바르게 전달되는 것은 아니므로, 일련 번호와 확인 응답 번호를 사용해서 **데이터가 손상되거나 유실된 경우 재전송하는 기능**을 **재전송 제어**라고 한다.

## 윈도우 크기(Window size)

TCP통신을 할 때, 상대방에게 받은 데이터(segment)를 일시적으로 보관하는 장소를 buffer(버퍼)라고 하는데, 버퍼 용량의 크기를 **Window size**라고 한다.

수신측의 Window size > Maximum segment size ? send : wait

→ 고수의 한마디 : 수신측의 어플리케이션 read 속도가 네트워크 속도보다 느리다면 overflow가 발생하여 처리 지연이 일어날 가능성이 크다. (수신이 늦어지는 이유가 네트워크 문제가 아니라 내 어플리케이션의 처리 속도 문제일 가능성을 고려하라)

## 포트 번호(port number)

어떤 어플리케이션인지 구분하는 역할

0 ~ 65535번을 사용할 수 있고, 세 종류로 구분된다.

- well-known port(잘 알려진 포트) : 0 ~ 1023번. 주요 프로토콜이 사용하며 일반적으로 서버 측 어플리케이션에서 사용
- registered port(등록된 포트) : 1024 ~ 49151번. 1024번은 사용되지 않고 1025번 이상은 랜덤 포트라고 하며 클라이언트 측의 송신 포트로 사용
- dynamic port(동적 포트) : 49152 ~ 65535

## TCP의 흐름 제어

**전송되는 데이터의 양을 조절**

송신 측의 데이터 처리 속도가 수신 측보다 빠를 때 수신 측 버퍼가 넘치는 **overflow** 문제가 발생한다. 이러한 문제를 줄이기 위해 window size를 이용해 **송신측의 데이터 전송량을 조절한다.**

### stop and wait

상대방에게 데이터를 보낸 후 잘 받았다는 응답이 올 때까지 기다리는 방식

### sliding window

송신 측이 수신 측에서 받은 윈도우 크기를 참고해서 데이터의 흐름을 제어하는 방식

- 수신 측이 한 번에 처리할 수 있는 데이터의 양(window size)을 3-way hankshake 할 때 송신 측에 전달
- 수신 측에게 응답을 받지 않아도 범위 내에서 데이터를 보냄

## TCP의 오류 제어

TCP는 통신 중에 오류가 발생하면 해당 데이터를 재전송한다.

즉, **재전송 기반 오류 제어 ARQ(Automatic Repeat Request)** 를 사용한다.

### stop and wait

**일정 시간이 지나** timeout이 발생하면 이전 데이터를 재전송하는 방식

### Go Back N

연속적으로 데이터를 보내다가 **오류가 발생한 지점부터 재전송**하는 방식

성공적으로 전송된 데이터까지 재전송하기 때문에 조금 비효율적

### Selective Reapeat

**오류가 발생한 데이터만 재전송**하는 방식

수신 측 버퍼의 데이터가 순차적이지 않다는 단점이 있음

## TCP의 혼잡 제어

네트워크 내에 패킷의 수가 과도하게 증가하는 현상을 혼잡이라고 한다.

혼잡 제어는 혼잡 현상을 방지하고 제거하기 위한 기능이다.

### AIMD (Additive Increase / Multiplicative Decrease)

- 패킷을 하나씩 보내고 문제가 발생하지 않으면 Window size를 1씩 증가시키는 방법
- 패킷 전송에 실패하거나 일정 시간이 넘으면 패킷 전송 속도를 절반으로 줄인다.
- 처음에 전송 속도를 올리는 시간이 오래 걸리고, 네트워크가 혼잡해지는 상황을 미리 감지하지 못하는 단점이 있다.

### Slow Start (느린 시작)

- AIMD와 같이 패킷을 하나씩 보내고 문제가 발생하지 않으면 각 ACK 패킷마다 윈도우 크기를 1씩 증가시키는 방법
- 전송 속도가 지수 함수 형태로 증가한다.
- 혼잡이 감지되면 윈도우 크기를 1로 줄인다.
- 한 번 혼잡 현상이 발생한 후에는 네트워크 수용량을 어느 정도 예상할 수 있어, 혼잡 현상이 발생하는 윈도우 크기의 절반까지는 지수 함수 꼴로 윈도우 크기를 증가시키고 그 이후에는 완만하게 1씩 증가시킨다.

### Fast Retransmit (빠른 재전송)

- 수신 측에서 먼저 도착할 패킷이 도착하지 않고 다음 패킷이 도착한 경우에도 ACK 응답 패킷을 보낸다.
- 송신측은 순번이 중복된 ACK 패킷을 받게 된다.
- 중복된 패킷임을 확인하게 되면 문제가 되는 순번의 패킷을 재전송해주며 혼잡한 상황이라고 판단해 윈도우 크기를 줄인다.
- 3 ACK Duplicated : 송신 측이 3번 이상 중복된 ACK 번호를 받은 상황

### Fast Recovery (빠른 회복)

- 혼잡한 상태가 되면 윈도우 크기를 1이 아니라 반으로 줄이고, 선형 증가시킨다.
- 혼잡 상황을 한 번 겪은 이후로는 AIMD 방식으로 동작한다.

---

# UDP(User Datagram Protocol)

전송 계층에서 **데이터를 효율적이고 빠르게 보낼 때 사용**되는 **비연결형** 통신 프로토콜

스트리밍 방식으로 전송하는 동영상 서비스와 같은 곳에 사용

재송신 기능, 확인 응답이 없고 TCP보다 빠른 속도를 가지며 체크섬 필드를 통해 최소한의 오류만을 검출한다.

효율성을 중요하게 여기기 때문에 작은 크기의 **UDP 헤더**를 가진다. 이 UDP헤더가 붙은 데이터를 **UDP 데이터그램**이라고 한다.

![UDP헤더](https://github.com/hajaeryul/mvc-20220927-jaeryul/assets/113097210/f761f598-42ec-4417-9aeb-5c5a7f8726d9)

## TCP와 UDP 비교

![TCP와UDP비교](https://github.com/hajaeryul/mvc-20220927-jaeryul/assets/113097210/93a7ea4c-eead-4775-9474-51ffd6b426de)

---

### 문제 1. OSI-7 계층에서 종단 간 신뢰성 있고 효율적인 데이터를 전송하기 위해 오류 검출과 복구, 흐름 제어를 수행하는 계층은?

[정답률 : 27%] 정보처리기사 필기 2020년 1회.2회 기출문제

① 전송 계층

② 세션 계층

③ 표현 계층

④ 응용 계층

### 문제 2. TCP 흐름 제어 기법 중 프레임이 손실 되었을 때, 손실된 프레임 1개를 전송하고 수신자의 응답을 기다리는 방식으로 한 번에 프레임 1개만 전송할 수 있는 기법은?

[정답률 : 34%] 정보처리기사 필기 2020년 4회 기출문제

① Slow Start

② Sliding Window

③ Stop and Wait

④ Congestion Avoidance

### 문제 3. UDP 특성에 해당되는 것은?

[정답률 : 31%] 정보처리기사 필기 2020년 4회 기출문제

① 데이터 전송 후, ACK를 받는다.

② 송신 중에 링크를 유지 관리하므로 신뢰성이 높다.

③ 흐름 제어나 순서 제어가 없어 전송 속도가 빠르다.

④ 제어를 위한 오버 헤드가 크다.

<details>
<summary>정답</summary>
<div>

①, ③, ③

</div>
</details>
