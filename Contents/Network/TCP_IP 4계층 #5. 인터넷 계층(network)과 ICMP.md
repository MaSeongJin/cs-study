# 인터넷 계층(Internet Layer)

- 장치로부터 받은 네트워크 패킷을 IP주소로 지정된 목적지로 전송하기 위해 사용되는 계층
- 인터넷 계층에 속하는 프로토콜 :  IP, **ICMP**, IGMP, ARP, RARP
- 데이터 단위 : IP 패킷
- 상대방이 제대로 받았는지에 대해 보장하지 않는 **비연결형적 특징**을 가진다.
- OSI 7계층의 네트워크 계층에 해당
- 인터넷 계층을 처리하는 기기로는 **라우터**, L3 스위치가 있다.

---
### 라우터

⇒ 여러 개의 네트워크를 연결, 분할, 구분시켜주는 역할을 하며 “다른 네트워크에 존재하는 장치끼리 서로 데이터를 주고받을 때 **패킷 소모를 최소화**하고 **경로를 최적화**하여 최소 경로로 패킷을 포워딩”하는 라우팅을 하는 장비

[![1.png](https://i.postimg.cc/gcyVcmgV/1.png)](https://postimg.cc/9zMRJ550)


# ICMP(Internet Control Message Protocol)

### 개요

- **인터넷 제어 메시지 프로토콜**로, IP와 조합하여 통신 중에 발생하는 오류의 처리와 전송 경로 변경 등을 위한 **제어 메시지를 관리**하는 역할을 한다.
- 헤더는 **8Byte**로 구성된다.
- 대표적인 프로그램으로 **PING**이 있다.
- 주로 통신 간에 장애나 목적지 시스템이 제대로 응답을 하여 동작하고 있는지를 판단하기 위한 용도로 활용된다.
- ICMP프로토콜은 패킷 전송시의 오류만 Report할 뿐 오류를 해결하는 역할은 못한다.

# ICMP 메시지의 구조

[![2-ICMP.png](https://i.postimg.cc/JnLsSBV9/2-ICMP.png)](https://postimg.cc/06V5wjNf)

8바이트의 헤더와 데이터 부분으로 구성됨.

Type 필드 : ICMP 메시지 타입

Code 필드 : ICMP 메시지 타입별로 추가적인 코드 제공

Checksum 필드 : ICMP 헤더의 손상여부 확인

Data 필드 : 오류보고 및 질의에 따라 다름

---


# ICMP 메시지 종류

[![3-ICMP.png](https://i.postimg.cc/0QPNVR7v/3-ICMP.png)](https://postimg.cc/5HK1trPK)

## 오류보고 메시지


**목적지 도착 불가능(Destination Unreachable) 메시지 ( 3 )**

- 코드 필드엔 데이터그램을 전달 할 수 없었던 이유를 명시한다.
- ex) 0: 하드웨어 고장, 2: 상위 프로토콜 도달 불가, 4: 단편화 불가 (Don't fragment)

[![4.png](https://i.postimg.cc/3JdxSZ0k/4.png)](https://postimg.cc/kBPCDKcC)

**출발지 억제(Source Quench) 메시지 ( 4 )**

- 라우터나 목적지 호스트에 혼잡 상황이 발생하면 데이터그램을 송신한 출발지 호스트에게 출발지 억제 메시지 전송
- 출발지 억제 메시지를 수신한 출발지 호스트는 출발지 억제 메시지가 수신되지 않을 때까지 데이터그램 전송 속도를 낮춤.

**시간 초과(Time Exceeded) 메시지 ( 11 )**

- IP 데이터그램의 TTL 값이 0이 될 때 라우터는 데이터그램을 폐기하고 해당 데이터그램을 송신한 호스트에게 시간 초과 메시지 전송 ( Code = 0 )
TTL (Time To Leave : 이 IP 데이터그램이 인터넷 상에서 얼마동안 survive 할 수 있는지를 표시함. 라우터를 몇개까지 거쳐갈 수 있는지로 표시함. 라우터를 하나 거쳐갈 때마다 1씩 감소..)
- **재조립 타이머**가 종료될 때까지 단편화된 데이터그램들이 모두 도착하지 않으면 목적지 호스트는 해당 데이터그램을 전송한 출발지 호스트에게 시간 초과 메시지 전 ( Code = 1 )

[![5.png](https://i.postimg.cc/zf1DfZth/5.png)](https://postimg.cc/jDZY89rq)

---
추가 ) IP 단편화

❍ 데이터그램의 크기가 크면 MTU(Maximum Transmission Unit)의 크기에 맞게 그 데이터를 나누는 것을 단편화라고 합니다. Ethernet MTU는 1500바이트이고 보통 MT가 정의되어 있지 않다면 576바이트의 기본 크기로 보냅니다.

❍ 단편화의 바이트구조를 보면, 1비트는 R이며 나중을 위해 사용을 보류한 비트이고, 다음 1비트는 DF로 나타내며, 이 값이 1을 나타내면 이 데이터그램은 단편화를 해서는 안된다는 뜻입니다. 다음 비트는 MF로 나타내며, 이 값이 1을 나타내면 이 데이터그램 뒤에 단편화된 데이터그램이 더 있다는 뜻입니다. 오프셋은 해당 단편화 조각이 원래 데이터에서 몇 번째 데이터인지를 표시해주는 값입니다. 오프셋은 8단위로 이루어져 있기 때문에 단편화를 하는 데이터는 8의 배수의 크기로 단편화과 되어야 합니다.

❍ 단편화는 발신지, 경유지에서도 발생할 수 있으며 최종 목적지에서 재조립 됩니다. 단편화의 단점은 단편 손실 시 데이터그램 전체를 재전송해야 합니다. IP계층은 데이터그램의 어떤 단편이 처음 도착하면 **타이머(일반적으로 30~60초)를 시작하고 시간이 지나면 단편은 폐기됩니다.**

---

**방향 재지정(Redirect) 메시지 ( 5 )**

- 호스트는 라우팅 프로토콜을 통한 라우팅 테이블 자동 갱신 과정에 불참(라우팅 트래픽 축소)
- 호스트는 디폴트 게이트웨이(라우터) 주소만 유지
- 호스트의 데이터그램을 수신한 라우터가 더 좋은 경로를 알고 있으면 ICMP 방향 재지정 메시지 전송
- 다른 라우터로 데이터그램 전송을 유도


**매개변수 문제(Parameter Problem) 메시지**

- IP 데이더그램의 헤더 정보의 문제로 인해 데이터그램을 처리할 수 없는 경우 출발지 호스트에게 데이터그램의 헤더의 어떤 매개변수에 문제가 있는지 통보



## 질의 메시지

**에코 요청 또는 응답(Echo Request or Reply) 메시지** : **핑(ping)** 프로그램

[![6.png](https://i.postimg.cc/x8NBHqq1/6.png)](https://postimg.cc/5Q1PW4wh)

- 식별자(Identifier) : 일반적으로 송신자의 프로세스 식별자를 표시
- 순서 번호(Sequence Number) : 에코 요청 메시지의 순서번호
- 에코 요청 메시지의 식별자와 순서 번호는 에코 응답 메시지에 동일하게 복사
- 송신자는 수신한 에코 응답 메시지에 대응되는 에코 요청 메시지 파악 가능
- 데이터 필드 : 에코 응답 메시지에 의해 정확하게 반복 송신될 정보가 에코 요청 메지지 송신자에 의해 포함
- ex) ping 클라이언트 프로그램은 현재 시간 정보가 포함, ping 서버는 이 정보를 에코 응답 메시지의 데이터 필드에 동일하게 복사하여 다시 ping 클라이언트에게 전달


**주소 마스크 요청 또는 응답(Address Mask Request or Reply) 메시지**

- 호스트가 자신의 IP 주소에 대한 넷마스크 정보를 알지 못할 경우 사용
- 하부 네트워크의 라우터에게 주소 마스크 요청 메시지를 직접 또는 방송(broadcast)으로 전송
- 라우터는 주소 마스크 응답 메시지를 통해 넷마스크 정보를 제공


**타임스탬프 요청 또는 응답(Timestamp Request or Reply)** 메시지

- 두 시스템의 시계 동기화

[![7.png](https://i.postimg.cc/85xNx26s/7.png)](https://postimg.cc/BL5rKwNG)

**라우터 찾기 또는 광고(Router Solicitation or Advertisement)**

- 호스트가 같은 네트워크의 라우터에 관한 정보를 얻기 위해 라우터 요청 메시지 방송
- 라우터 요청 메시지를 받은 라우터는 라우터 광고 메시지를 사용하여 자신의 주소(또는 자신이 알고 있는 라우터 주소) 정보를 전송
- 라우터는 주기적으로 광고 메시지 전송 가능

[![8.png](https://i.postimg.cc/L6KmDMSb/8.png)](https://postimg.cc/mhjxZJtY)

### 기출문제 풀이
---

2020년 3회 정보처리기사 실기 기출문제

다음 지문의 괄호에 들어갈 알맞은 용어를 영문(Full name 또는 약어)으로 쓰시오.

```java
(     )는 TCP/IP 기반의 인터넷 통신 서비스에서 인터넷 프로토콜(IP)과 조합하여
통신 중에 발생하는 오류의 처리와 전송 경로의 변경 등을 위한 제어 메시지를 취급하는
무연결 전송용 프로토콜로, OSI 기본 참조 모델의 네트워크 계층에 속한다.
```

---

2022년 3회 정보처리기사 기출

다음에서 설명하는 유틸리티가 무엇인지 쓰시오

```java
ICMP(Inter Control Message Protocol)를 사용하여 특정 호스트로의
연결 가능 여부를 확인하는 유틸리티이다. ICMP 에코 요청 패킷을 대상
호스트로 전송한 후 ICMP 에코 응답을 받으면 해당 호스트는 연결 가능한
호스트임이 확인된다.
```

