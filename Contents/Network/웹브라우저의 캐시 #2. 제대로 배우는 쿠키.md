# 제대로 배우는 쿠키

## Cookie란?

HTTP 프로토콜은 **Stateless**한 속성을 가지고 있기 때문에, **서버와 클라이언트간의 연결 유지**를 위해 서로를 인식할 수 있는 데이터가 필요해졌고, 그것이 **쿠키**이다.

- 서버가 사용자의 웹 브라우저에 전송하는 작은 데이터 조각
- key = value 형식의 문자열 데이터 묶음
- 브라우저는 이 문자열 데이터 조각들을 저장해 놓았다가 동일한 서버에 재 요청시 쿠키 데이터를 전송

## 쿠키의 목적

### 세션 관리 (Session Management)

- 서버 간 일시적인 연결 유지
- 로그인 유지, 장바구니 기능 등

### 개인화 (Personalization)

- 웹사이트에 대한 사용자 선호, 테마 등의 세팅
- 다크 모드, 언어 설정, 메뉴 순서 최적화 등

### 트래킹 (Tracking)

- 사용자 행동을 기록하고 분석
- 분석 데이터 수집, 리타게팅 광고에 기여

이처럼 쿠키의 활용도는 여러 가지가 있지만, **정보가 클라이언트 측에서 관리**되기 때문에 악용될 우려가 있고, 보안에 취약하여 정보가 탈취 당할 위험성이 존재한다. 그래서 보안에 민감한 개인 정보를 제외한 최소한의 정보만을 사용해야 한다.

웹 사이트에 접속했을 때, 쿠키 수집에 대한 동의를 요구하는 팝업이나 배너를 본 적이 있을 것이다. 우리나라 개인정보 보호법에서는 쿠키 수집에 대한 동의를 필수 항목으로 규정하고 있지 않지만, 해외에서는 GDRP 및 ePrivacy Directive(EDP)라는 유럽의 ‘전자 프라이버시 규정’에 이에 대한 내용이 있어 팝업 창을 통해 동의 받는 경우가 많다.

## 브라우저의 쿠키 확인

- F12(개발자 도구) → 상단에 Application 탭 → 좌측 사이드 바 Cookies 탭
![쿠키확인](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/ec466b56-5460-4553-9192-993727b18566)
- 개발자 도구에서 쿠키 추가, 쿠키 편집, 쿠키 삭제도 가능하다

## 쿠키의 흐름
![쿠키흐름](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/bcf1af35-a899-4f50-8d39-7cba748151d1)
1. 로그인 (/login) 화면에서 클라이언트가 username과 password를 입력하고 서버에 request(요청) 한다.
2. 서버는 DB를 조회하여 해당 유저 정보 데이터를 가져와 검증하고 세션 메모리에 저장한다. 그리고 이 세션 데이터를 식별하는 세션 아이디(SessionID)를 쿠키로 만들어 반환한다. (Set-Cookie)
3. 클라이언트는 응답 받은 쿠키를 브라우저에 저장해 놓는다. 그리고 나중에 대시보드(/dashboard) 창에 진입하기 위해 서버에게 요청을 보낼 때 쿠키를 같이 실어 보낸다.
4. 서버는 클라이언트로부터 온 쿠키에 들은 세션 아이디를 파싱하여 올바른지 검증하고, 로그인한 회원이라면 그에 걸맞는 대시보드 페이지를 응답한다.

## Cookie (요청 헤더)

- HTTP Request 클라이언트 → 서버 전달하는 쿠키 헤더
- 각종 클라이언트 정보들과 SessionID를 담고 있다.
![쿠키요청헤더](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/b1b88425-c592-41b2-8cc6-83e5918ca6e3)

## Set-Cookie (응답 헤더)

- HTTP Response 서버 → 클라이언트 전달하는 쿠키 헤더
- 클라이언트는 이 정보를 바탕으로 쿠키를 만들어 브라우저에 저장
![쿠키응답헤더](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/e597715b-bb77-4e28-ae19-c35b3048a464)

## 쿠키의 저장 방식

- 쿠키는 key = value 형태로 저장되는 문자열로서 여러 개의 데이터를 콤마(,)로 열거하여 저장해 구분한다.
- 쿠키는 유효 기간이나 도메인 등을 설정한 파라미터들을 세미콜론(;)을 통해 열거한다.
![쿠키저장방식](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/5db4435b-0979-4606-be18-7acad682c76a)

## HTTP Cookie 파라미터

- 쿠키의 유효 기간이나 도메인 설정 등을 파라미터를 통해 추가할 수 있다. 이 파라미터들은 **클라이언트(브라우저)에 적용되는 속성**들이며, 서버에서 응답할 때 설정할 수도 있다. 위에서 언급했듯 개발자 도구에서도 파라미터를 조작할 수 있다.

| 필드 속성 | 설명  |
| --- | --- |
| NAME=VALUE | 쿠키에 부여된 이름과 값 (필수) |
| Expires=DATE | 쿠키 유효 기간 |
| Path=PATH | 쿠키 적용 대상이 되는 디렉토리 |
| Domain=도메인명 | 쿠키 적영 대상이 되는 도메인명 |
| Secure | HTTPS로 통신하는 경우에만 쿠키를 송신 |
| HTTPOnly | 쿠키를 자바스크립트에서 액세스하지 못하도록 제한 |
| SameSite | 크로스 사이트(Cross-site)로 전송하는 요청의 경우 서드 파티 쿠키의 전송에 제한 |

### 쿠키 생명 주기
![쿠키생명주기](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/54ed6fe7-483f-47fc-ba45-43063dd586c1)

- *expires*와 *max-age*를 통해 만료일을 설정할 수 있다.
  - *expires*는 구체적인 날짜를 명시
  - 만료일이 지나면 쿠키는 삭제
  - *max-age*는 쿠키 유효 시간을 명시(초 단위)
  - 0이나 음수로 지정할 경우 쿠키는 삭제
- 만료 날짜를 생략하면 브라우저 종료시 까지만 유지된다. 이를 **세션 쿠키(Session Cookie)** 라 부른다.
- 만료 날짜를 입력하면 해당 날까지 유지된다. 이를 **영속 쿠키(Persistent Cookie)** 라 부른다. 디스크에 저장된다.

### 쿠키 Path
![쿠키Path](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/32f5cee4-bbff-49dd-8e31-7b1ad95047c2)

- 쿠키에 경로를 설정하면, 해당 페이지 경로에서만 쿠키 접근이 가능하다.
- 해당 경로의 하위 경로까지 모두 포함한다. 루트 경로(/)로 설정하면 모든 경로에서 쿠키가 유효하다는 뜻
- *Path*를 입력하지 않으면 루트 경로로 자동 입력 된다.
- 쿠키의 경로 범위를 좁게 잡을수록 보안에 좋겠죠?

### 쿠키 Domain
![쿠키Domain](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/3c06fdf4-d19d-46b0-ba20-44aa5d91096a)

- 쿠키에 도메인을 설정하면, 해당 도메인 페이지에서만 쿠키 접근이 가능하다.
- 현재 도메인에서 설정한 쿠키를 **퍼스트 파티 쿠키(First-party cookie)** 라 하고, 다른 도메인으로 설정된 쿠키를 **서드 파티 쿠키(Third-party cookie)** 라 한다.

#### 서드 파티 쿠키(Third-party Cookie)
- 도메인 파라미터를 전혀 다른 도메인으로 설정된 쿠키를 서드 파티 쿠키라 한다.
![서드파티쿠키](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/627c68e7-f26b-4fec-906d-ff71f7ba12a5)

- 위의 그림에서처럼 example 사이트는 우측 배너를 통해 광고가 표시되는데, 이 배너 광고는 adserver 사이트와 연결이 되어 있다.
- 사용자가 방문하고 있는 도메인에서 발행되는 쿠키A는 퍼스트 파티 쿠키이고, 타 도메인에서 발행되는 쿠키B는 서드 파티 쿠키라 한다.
- 서드 파티 쿠키는 주로 타깃 마케팅 광고 목적으로 사용된다. 내가 자주 검색했던 제품이 배너 광고에서 나타나는 것이 서드 파티 쿠키를 이용한 것이다.
- 구글은 22년 서드 파티 쿠키 폐지를 예고했지만 24년까지 연기했다. 프라이버시 샌드박스 API를 통해 사람들의 개인 정보를 개선하는 동시에 기업이 온라인에서 성공하는 데 필요한 도구를 제공하겠다는 계획이다.

### 쿠키 Secure
![쿠키Secure](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/54820dad-e3fe-4474-8dca-e4fda16ad0f0)

- 활성화하면, HTTPS 사용 시에만 쿠키 정보 전달
- 미적용 시에는 HTTP, HTTPS 구분하지 않고 쿠키 정보 전달

### 쿠키 HttpOnly

- 자바스크립트에서 쿠키 사용 접근을 제한
- 해커가 자바스크립트로 쿠키를 탈취할 수 없어, XSS 공격 방지 가능

### 쿠키 SameSite
![쿠키samesite](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/1c5b4b24-07e0-471d-818e-e3df23340528)

- SameSite 속성은 서드 파티 쿠키의 보안적 문제를 해결하기 위해 만들어진 기술이다.
- XSRF, CSRF 공격을 방지할 수 있다.
- 요청 도메인과 쿠키 정보 내의 도메인이 다른 크로스 사이트(Cross-site)로 전송하는 요청에 대해서 제한을 둘 수 있다.

#### SameSite 속성

파라미터 값으로 *None*, *Strict*, *Lax* 세 가지 종류를 선택할 수 있다. 전송의 제한은 서드 파티 쿠키에 한한다.

- None : 쿠키는 크로스 사이트 요청의 경우에도 항상 전송한다. 따라서 보안적으로 SameSite 적용을 하지 않은 쿠키와 다름이 없다.
  
  크롬 브라우저는 SameSite값으로 *None*을 사용하려면 반드시 Secure가 설정된 쿠키여야 한다는 정책이 있다.
  
- Strict : 쿠키는 크로스 사이트 요청에는 전송되지 않는다. 가장 보수적
  
- Lax : *Strict*에 비해 상대적으로 느슨한 속성. 몇 가지 예외적인 요청에는 전송하도록 한다.
  
  - <a>태그를 클릭해 리다이렉트를 하거나, 자바스크립트의 window.location.replace 등으로 인해 자동으로 이루어지는 이동에서는 서드 파티 쿠키가 전송된다.
  - GET 요청에 대해선 쿠키가 전송되지만, POST나 DELETE 요청은 제한된다.

## XSS(Cross Site Scripting)

- 서버 측에서 제공되는 Script가 아닌 권한이 없는 사용자(이하 해커)가 웹사이트에 Script를 삽입하여 의도치 않은 동작을 일으키는 공격
- 주로 JavaScript로 작성된 Script를 통해 공격이 가해진다.
- HttpOnly가 설정되지 않은 쿠키는 JavaScript를 통해 접근이 가능해, 해커가 탈취할 수 있다.

## XSRF(Crose-Site Request Forgery)

- 사이트 간 요청 위조(XSRF 또는 CSRF라고 한다)는 사용자가 자신의 의자와 무관하게 공격자가 의도한 행위(수정, 삭제, 등록 등)를 특정 웹사이트에 요청하게 하는 공격
![xsrf](https://github.com/hajaeryul/stussy-clone-20220930-jaeryul/assets/113097210/8402bc45-b1b5-41fb-8e3a-c1f1259c3ba6)

1. 이용자는 웹사이트에 로그인하여 정상적인 쿠키를 발급 받는다.
2. 공격자는 링크를 이메일이나 게시판 등의 경로를 통해 이용자에게 전달한다.
3. 위의 링크는 도착지 정보를 변조한 링크이다.
4. 이용자가 공격용 페이지에 접근 시 쿠키에 저장된 sessionID는 브라우저에 의해 자동으로 서버로 요청된다.
5. 서버는 쿠키에 담긴 sessionID를 통해 해당 요청이 인증된 사용자로부터 온 것으로 판단하고 처리한다.
