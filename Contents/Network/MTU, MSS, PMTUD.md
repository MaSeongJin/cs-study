# TCP / IP 4계층 MTU, MSS, PMTUD
## MTU
- 데이터 송수신 시 패킷이 쪼개지면서 데이터를 송수신하며, 이 때 패킷은 MTU(Maximum Transmission Unit)를 기반으로 쪼개진다.
- MTU는 네트워크 통신시 가장 큰 PDU 의 크기를 말한다.
    - PDU (Protocol Data Unit)는 동일 통신계층(즉, Peer-to-Peer) 간에 운반(교환)되는 전체 데이터량 (실제데이터 + 운반수단)
> 즉, 네트워킹에서 **MTU(Maximum Transmission Unit)** 란 네트워크에 연결된 장치가 받아들일 수 있는 최대 데이터 패킷 크기를 말합니다. 지하도로나 터널의 높이 제한처럼 생각할 수 있습니다. 높이 제한보다 높은 차량은 이를 통과하지 못하는 것처럼 네트워크의 MTU보다 큰 패킷은 해당 네트워크를 통과하지 못합니다.
하지만 차량과는 달리 MTU보다 큰 데이터 패킷은 작은 조각으로 잘라 MTU에 맞출 수 있습니다. 이 과정을 분할이라고 합니다. 분할된 패킷은 목적지에 도착하면 다시 조립됩니다.
MTU의 단위는 바이트입니다. "바이트"는 8개 비트의 정보(즉, 8개의 0과 1)를 의미합니다. 최대 MTU 크기는 **1,500바이트**입니다.
- L2 계층(프레임)에서 전달 받을 수 있는 L3 계층(패킷)의 최대 사이즈
- L3 계층(패킷)이 설정된 MTU 사이즈보다 클 경우 IP 단편화가 이루어져 전송 속도에 영향을 줄 수 있음
    - **IP 단편화**는 상대적으로 큰 데이터그램을 더 작은 정보 패킷으로 분리하는 과정이다.
- L2 계층(프레임)은 Ethernet 헤더(14byte), 데이터(L3(패킷, MTU, 1500byte)), Ethernet 꼬리(4byte)를 포함하여 1518byte로 구성</br>
    [![1.png](https://i.postimg.cc/G2Z5Tynb/1.png)](https://postimg.cc/r0NJvzpH)</br>
- 하지만 패킷이 분리되지 않는 경우도 존재 한다!
- 이 경우 MTU 를 초과하여 분할할 수 없는 경우 아예 전달하지 않을 수도 있다!
- IPv6는 분할을 허용하지 않고 IPv4는 헤더에 flags라는 필드가 존재하여 bit가 1이되면 "Dont Fragment"가 활성화되면서 분할이 불가능해진다.
    - 여기서 잠깐💡 IPv4와 IPv6? </br>
        - IPv4란 'Internet Protocol Version 4'라는 의미입니다. 말 그대로 인터넷 프로토콜의 4번째 버전이며, 전세계적으로 사용된 1번째 인터넷 프로토콜입니다. 주소는 32비트로 구성되어 있으며 마침표로 구분되는 4개의 8비트 필드로 구분된 10진수로 작성됩니다. '점으로 구분된 십진수 형식'이라고도하며 아래의 이미지가 IPv4 주소의 예시 이미지입니다.</br>
        [![1.png](https://i.postimg.cc/c4V3GzJ6/1.png)](https://postimg.cc/dLj384rK)</br>
        현재 인터넷에서 사용되어지고 있는 표준 프로토콜은 IPv4입니다.

        - IPv6는 IPv4와 마찬가지로 'Internet Protocol Version 6'라는 의미입니다. IPv4가 32비트라는 제한된 주소 공간 및 국가별 할당된 주소가 거의 소진되고 있다는 한계점으로 인해 문제가 예상되는데 그 대안으로 IPv6 프로토콜이 제안되었습니다. 128비트의 무제한 인터넷 프로토콜 주소를 말하며 16비트 단위(0~ffff 범위)로 구분짓고 콜론(:)으로 구분 표시를 합니다. 주소 표기시 기억할 점은 맨 앞의 0은 생략될 수 있으며 연속되는 0의 경우는 콜론 2개(::)로 표현할 수 있다는 것입니다.</br>
        [![2.png](https://i.postimg.cc/C59RYZS9/2.png)](https://postimg.cc/RJQSLZ3T)</br>
        - IPv4와의 가장 큰 차이점은 IP 주소 길이가 128 비트로 늘어났다는 점입니다. 급증하는 네트워크 디바이스들의 인터넷 사용을 대비한 것이죠. 이 외에도 아래와 같은 장점들이 있습니다.

        1. 확대된 주소 공간 : 주소 길이가 128비트로 증가

        2. 단순해진 헤더 포맷 : IPv4 헤더의 불필요한 필드를 제거하여 보다 빠른 처리 가능
        [![1.png](https://i.postimg.cc/zX4JXH9X/1.png)](https://postimg.cc/dLmM53sz)
        3. 간편해진 주소 설정 : IPv6 프로토콜에 내장된 주소를 자동 설정 기능을 이용하여 플러그 앤플레이 설치가 가능

         4. 강화된 보안 기능 : IPv6에서는 IPSec 기능을 기본 사항으로 제공
        - IPSec이란 무엇인가요? IPSec은 네트워크에서의 안전한 연결을 설정하기 위한 통신 규칙 또는 프로토콜 세트입니다.
        5. 개선된 모바일 IP : IPv6 헤더에서 이동성 지원
        -  "이동성"은 디바이스나 사용자가 네트워크에서 이동하면서 연결을 유지하고 효과적으로 통신할 수 있는 능력을 나타냅니다. 예를 들어, 스마트폰을 사용하면서 집에서 출발하여 이동 중에도 연결된 상태로 웹 브라우징, 이메일 확인, 음성 통화 등을 계속할 수 있어야 합니다.

IPv6 프로토콜은 IPv4에 비해 개선된 이동성 지원을 제공합니다. IPv6 헤더에서 이동성을 지원하는 것은 디바이스가 네트워크에서 이동하면서 IPv6 주소 및 연결 정보를 업데이트하고 이동 중에도 연결을 유지할 수 있도록 하는 기능을 의미합니다. 이로써 사용자 또는 디바이스가 네트워크 간 전환이나 이동 시에도 데이터 통신이 끊김 없이 지속될 수 있습니다.
- PC에서도 설정된 MTU 확인 가능!!!
    [![1.png](https://i.postimg.cc/zvcN2kMK/1.png)](https://postimg.cc/MfVgv1zp)


## TCP MSS(Maximum Segement Size)
- L4(세그먼트, 전송계층)에서 전달 받을 수 있는 L5~L7계층(메세지)의 최대 길이
- TCP 헤더에 따라 사이즈가 달라질 수 있지만 TCP 헤더에 option이 추가 설정되지 않았다면 기본 1460byte</br>
(TCP 헤더의 option은 최대 40byte까지 추가 될 수 있음)
- **MSS ( Maximum Segment Size )** 는 TCP 에서 사용할 수 있는 데이터의 크기이자 TCP 헤더, IP 헤더를 뺀 크기를 말한다(예를 들어 터널의 높이 제한)
- 통신을 하는 양쪽 끝은 두 장치의 MTU 만이 아니라 중간의 모든 라우터, 스위치, 서버를 고려하며 네트워크 경로상에 있는 아무 장치나 MTU 보다 패킷이 크면 분할될 수 있다. </br>
[![1.png](https://i.postimg.cc/rpfqtcJf/1.png)](https://postimg.cc/WDqBQBxZ)

## PMTUD(Path MTU Discovery)
- PMTUD(Path MTU Discovery)는 수신자와 송신자의 경로 상에서 장치가 패킷을 누락한 경우 테스트 패킷의 크기를 낮추면서 MTU에 맞게 반복해 보내는 과정 </br>
[![1.png](https://i.postimg.cc/bJGPZwTp/1.png)](https://postimg.cc/xJSh7Yh4)

① 호스트 A가 호스트 B로 IPv6 패킷을 전송할 때 먼저 링크 A의 MTU 크기에 맞게 패킷을 분할한 후 전송한다.

   

② 호스트 A로부터 패킷을 받은 라우터 A는 패킷이 전송될 링크 B의 MTU 크기를 확인한다. 받은 패킷의 크기가 링크 B의 MTU 크기보다 클 경우는 해당 패킷을 더 이상 라우팅 하지 못하고 호스트 A에서 ICMPv6 메시지 타입 2인 패킷 크기 초과 메시지를 되돌려준다.
- ICMPv6는 Internet Control Message Protocol for IPv6의 약어로, IPv6 네트워크에서 발생하는 여러 종류의 네트워크 상태 및 오류 메시지를 전달하는 프로토콜입니다. ICMPv6 메시지는 IPv6 네트워크에서 통신의 문제를 해결하고 네트워크 상태를 모니터링하는 데 사용됩니다.

   

③ 패킷 크기 초과 메시지를 받은 호스트 A는 ICMPv6 메시지에 표시되어 있는 링크 B의 MTU 크기에 맞게 패킷을 분할한 후 다시 전송한다. 그러면 이제 라우터 A는 링크 B의 MTU 크기보다 작은 패킷을 받았으므로 해당 패킷을 정상적으로 라우팅할 수 있다.

   

④ 1000바이트로 분할된 패킷을 받은 라우터 B는 라우터 A와 마찬가지로 패킷이 전송될 링크 C의 MTU 크기와 비교한다. 받은 패킷의 크기가 더 클 경우는 해당 패킷을 더 이상 라우팅 하지 못하고 호스트 A에게 패킷 크기 초과 메시지를 되돌려 준다.
- 라우터는 네트워크에서 패킷을 전달하고 라우팅하는 네트워크 장비입니다. 라우터는 패킷을 다음 목적지로 라우팅하고 패킷의 경로를 결정합니다. 글에서 언급된 라우터 A 및 라우터 B는 패킷을 목적지 호스트 B로 전달하기 위해 사용되는 라우터입니다.
- 라우팅은 패킷이 발신지에서 목적지로 전달되는 경로를 결정하고 제어하는 프로세스를 나타냅니다. 라우터는 패킷을 수신하고 해당 패킷을 다음 라우터로 전달하거나, 패킷이 목적지에 도달하게끔 패킷의 경로를 결정합니다. 라우팅은 네트워크에서 데이터가 이동하는 방식을 관리하고 최적 경로를 선택하는 데 사용됩니다.
   

⑤ 패킷 크기 초과 메시지를 받은 호스트 A는 ICMPv6 메시지에 표시되어 있는 링크 C의 MTU 크기에 맞게 패킷을 분할한 후 다시 전송한다. 그러면 이제 라우터 B는 링크 C의 MTU 크기보다 작은 패킷을 받았으므로 해당 패킷을 정상적으로 라우팅할 수 있으며, 최종적으로 패킷은 목적지로 호스트 B에 도착한다.

   

⑥ 호스트 A는 더 이상 패킷 크기 초과 메시지를 받지 않으므로 호스트 B를 목적지로 하는 패킷은 계속 500바이트로 분할하여 전송한다. 이후 호스트 A는 주기적으로 다시 자신의 링크 MTU 크기에 맞게 패킷을 분할하여 전송함으로써, 경로상의 최소 MTU 값이 변경되지 않았는지 확인하는 과정을 거친다.


## 문제
문제 1. IPv6의 특징 중 옳지 않은 것은?
 1. 브로드 캐스트가 가능하다.
 2. 128bit의 주소 길이를 갖는다.
 3. 16bit씩 8부분으로 16진수로 표시한다.
 4. IPSec을 기본적으로 지원한다.

<details>
<summary>문제 해설</summary>
<div markdown="1">
답: 4번</br>
IPv4 유니캐스트,멀티캐스트,브로드캐스트</br>
IPv6 유니캐스트,멀티캐스트,애니캐스트</br>
</div>
</details>
